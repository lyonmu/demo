# Envoy L4/L7 Proxy Demo

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Envoy ä½œä¸º L7 ä»£ç†çš„æ¼”ç¤ºé¡¹ç›®ï¼Œå±•ç¤ºäº† HTTPS ç»ˆæ­¢ã€å¤šç«¯å£ç›‘å¬ã€é™æ€é›†ç¾¤è´Ÿè½½å‡è¡¡ä»¥åŠ Admin æ¥å£çš„ä½¿ç”¨ã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

- **HTTPS æ”¯æŒ**ï¼šä½¿ç”¨è‡ªç­¾åè¯ä¹¦è¿›è¡Œ TLS ç»ˆæ­¢ã€‚
- **å¤šç«¯å£ç›‘å¬**ï¼š
  - `10000` -> è½¬å‘è‡³ `192.168.8.99:30880`
  - `10001` -> è½¬å‘è‡³ `192.168.8.99:31672`
  - `10002` -> è½¬å‘è‡³ `192.168.8.99:31983`
- **Admin æ¥å£**ï¼šç›‘å¬ç«¯å£ `9901`ï¼Œç”¨äºæŸ¥çœ‹ Envoy è¿è¡Œæ—¶çŠ¶æ€ã€‚
- **è®¿é—®æ—¥å¿—**ï¼šé…ç½®äº†æ ‡å‡†è¾“å‡º (stdout) æ—¥å¿—è®°å½•ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£… [Docker](https://www.docker.com/) å’Œ [Docker Compose](https://docs.docker.com/compose/)ã€‚

### 2. ç”Ÿæˆè¯ä¹¦ (å¯é€‰)

å¦‚æœ `certs/` ç›®å½•ä¸‹æ²¡æœ‰è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼š

```bash
mkdir -p certs
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout certs/example.com.key \
  -out certs/example.com.crt \
  -subj "/CN=example.com"
```

### 3. å¯åŠ¨æœåŠ¡

ä½¿ç”¨ Docker Compose å¯åŠ¨ Envoy ä»£ç†ï¼š

```bash
docker compose up -d
```

### 4. éªŒè¯è®¿é—®

ç”±äºä½¿ç”¨äº†è‡ªç­¾åè¯ä¹¦ï¼Œ`curl` è¯·æ±‚æ—¶éœ€è¦åŠ ä¸Š `-k` (æˆ– `--insecure`) å‚æ•°ã€‚

```bash
# è®¿é—®æœåŠ¡ 1 (è½¬å‘è‡³ 30880)
curl -k -v https://localhost:10000

# è®¿é—®æœåŠ¡ 2 (è½¬å‘è‡³ 31672)
curl -k -v https://localhost:10001

# è®¿é—®æœåŠ¡ 3 (è½¬å‘è‡³ 31983)
curl -k -v https://localhost:10002
```

### 5. æŸ¥çœ‹ Admin ç•Œé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š[http://localhost:9901](http://localhost:9901)

## ğŸ“‚ ç›®å½•ç»“æ„

- `envoy.yaml`: Envoy ä¸»é…ç½®æ–‡ä»¶ã€‚
- `docker-compose.yml`: Docker å®¹å™¨ç¼–æ’æ–‡ä»¶ã€‚
- `certs/`: å­˜æ”¾ SSL è¯ä¹¦å’Œç§é’¥ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

### Docker Compose

å®¹å™¨é…ç½®äº†èµ„æºé™åˆ¶ï¼š

- CPU: 1.0
- Memory Limit: 1024M
- Memory Reservation: 512M
- Network Mode: `host` (ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œå †æ ˆ)

### Envoy

- **Listener**: é…ç½®äº† 3 ä¸ªç‹¬ç«‹çš„ Listenerï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒçš„ä¸šåŠ¡ç«¯å£ã€‚
- **Cluster**: é…ç½®äº† 3 ä¸ªé™æ€ Clusterï¼ŒæŒ‡å‘åç«¯æœåŠ¡ IP `192.168.8.99`ã€‚
